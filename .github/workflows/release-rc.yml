name: Release Candidate Build

on:
  push:
    branches: [ dev ]

concurrency:
  group: release-rc-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release-rc:
    name: Build & Push RC Image
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          # Get the current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          # Get short SHA for unique RC identifier
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Create RC version: current version + rc + short sha
          RC_VERSION="${CURRENT_VERSION}-rc.${SHORT_SHA}"
          
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "rc_version=${RC_VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Current version: ${CURRENT_VERSION}"
          echo "ðŸ·ï¸ RC version: ${RC_VERSION}"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install server dependencies
        run: npm ci --ignore-scripts

      - name: Install client dependencies
        run: |
          cd client
          npm ci

      - name: Build client
        run: |
          cd client
          npm run build
          echo "âœ… Client build successful"

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push RC Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/youtarr:${{ steps.version.outputs.rc_version }}
            ${{ vars.DOCKERHUB_USERNAME }}/youtarr:dev-latest
          no-cache: true

      - name: Summary
        run: |
          echo "## ðŸš€ Release Candidate Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ vars.DOCKERHUB_USERNAME }}/youtarr:${{ steps.version.outputs.rc_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ vars.DOCKERHUB_USERNAME }}/youtarr:dev-latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Specific RC version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ vars.DOCKERHUB_USERNAME }}/youtarr:${{ steps.version.outputs.rc_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Latest dev build" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ vars.DOCKERHUB_USERNAME }}/youtarr:dev-latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** This is a release candidate for testing. Use \`latest\` for stable releases." >> $GITHUB_STEP_SUMMARY

