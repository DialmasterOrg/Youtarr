name: Upstream Compatibility Check

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  lint:
    name: ESLint & TypeScript Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install client dependencies
        run: |
          cd client
          npm ci

      - name: Run ESLint on Backend
        id: lint-backend
        run: npx eslint ./server/. --ext .js
        continue-on-error: true

      - name: Run ESLint on Frontend
        id: lint-frontend
        run: npx eslint ./client/src/. --ext .ts,.tsx
        continue-on-error: true

      - name: Run TypeScript Type Checking
        id: typescript-check
        run: npm run lint:ts
        continue-on-error: true

      - name: Check Linting Results
        if: steps.lint-backend.outcome == 'failure' || steps.lint-frontend.outcome == 'failure' || steps.typescript-check.outcome == 'failure'
        run: |
          echo "❌ Linting/Type checking failed!"
          if [ "${{ steps.lint-backend.outcome }}" == "failure" ]; then
            echo "Backend linting failed"
          fi
          if [ "${{ steps.lint-frontend.outcome }}" == "failure" ]; then
            echo "Frontend linting failed"
          fi
          if [ "${{ steps.typescript-check.outcome }}" == "failure" ]; then
            echo "TypeScript type checking failed"
          fi
          exit 1

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run backend tests with coverage
        run: npm run test:backend -- --coverage --coverageReporters=json-summary --coverageReporters=lcov --coverageReporters=text
        env:
          NODE_ENV: test

      - name: Check backend coverage threshold
        run: |
          coverage_file="coverage/coverage-summary.json"
          if [ -f "$coverage_file" ]; then
            lines=$(node -p "require('./$coverage_file').total.lines.pct")
            statements=$(node -p "require('./$coverage_file').total.statements.pct")
            functions=$(node -p "require('./$coverage_file').total.functions.pct")
            branches=$(node -p "require('./$coverage_file').total.branches.pct")

            echo "Backend Coverage:"
            echo "  Lines: ${lines}%"
            echo "  Statements: ${statements}%"
            echo "  Functions: ${functions}%"
            echo "  Branches: ${branches}%"

            if (( $(echo "$lines < 70" | bc -l) )); then
              echo "❌ Backend line coverage is below 70% threshold (${lines}%)"
              exit 1
            fi

            echo "✅ Backend coverage meets minimum threshold (70%)"
          else
            echo "❌ Coverage report not found"
            exit 1
          fi

      - name: Upload backend coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: |
            coverage/coverage-summary.json
            coverage/lcov.info

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install client dependencies
        run: |
          cd client
          npm ci

      - name: Install Playwright browsers
        run: |
          cd client
          npx playwright install --with-deps

      - name: Run frontend tests with coverage
        run: cd client && npm test -- --coverage --coverageReporters=json-summary --coverageReporters=lcov --coverageReporters=text --watchAll=false
        env:
          CI: true

      - name: Check frontend coverage threshold
        run: |
          coverage_file="client/coverage/coverage-summary.json"
          if [ -f "$coverage_file" ]; then
            lines=$(node -p "require('./$coverage_file').total.lines.pct")
            statements=$(node -p "require('./$coverage_file').total.statements.pct")
            functions=$(node -p "require('./$coverage_file').total.functions.pct")
            branches=$(node -p "require('./$coverage_file').total.branches.pct")

            echo "Frontend Coverage:"
            echo "  Lines: ${lines}%"
            echo "  Statements: ${statements}%"
            echo "  Functions: ${functions}%"
            echo "  Branches: ${branches}%"

            if (( $(echo "$lines < 70" | bc -l) )); then
              echo "❌ Frontend line coverage is below 70% threshold (${lines}%)"
              exit 1
            fi

            echo "✅ Frontend coverage meets minimum threshold (70%)"
          else
            echo "❌ Coverage report not found"
            exit 1
          fi

      - name: Upload frontend coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: |
            client/coverage/coverage-summary.json
            client/coverage/lcov.info

  check-all:
    name: All Checks
    runs-on: ubuntu-latest
    needs: [lint, test-backend, test-frontend]
    if: always()
    steps:
      - name: Check all results
        run: |
          echo "Checking results of all jobs..."
          echo "Lint: ${{ needs.lint.result }}"
          echo "Backend Tests: ${{ needs.test-backend.result }}"
          echo "Frontend Tests: ${{ needs.test-frontend.result }}"

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test-backend.result }}" != "success" ] || \
             [ "${{ needs.test-frontend.result }}" != "success" ]; then
            echo ""
            echo "❌ One or more checks failed!"
            echo ""
            echo "Failed checks:"
            [ "${{ needs.lint.result }}" != "success" ] && echo "  - Linting"
            [ "${{ needs.test-backend.result }}" != "success" ] && echo "  - Backend Tests"
            [ "${{ needs.test-frontend.result }}" != "success" ] && echo "  - Frontend Tests"
            exit 1
          fi

          echo ""
          echo "✅ All checks passed successfully!"
