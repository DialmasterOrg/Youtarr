
services:
  youtarr-db:
    image: mariadb:10.3
    container_name: youtarr-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-123qweasd}
      MYSQL_DATABASE: ${DB_NAME:-youtarr}
      MYSQL_TCP_PORT: ${DB_PORT:-3321}
      # Set utf8mb4 as default for new installations
      # Previously youtarr always used root, so keeping this default for backwards compatibility
      MYSQL_USER: ${DB_USER:-root}
      MYSQL_PASSWORD: ${DB_PASSWORD:-123qweasd}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "${DB_PORT:-3321}:${DB_PORT:-3321}"
    volumes:
      - ./database:/var/lib/mysql
      # macOS (Apple Silicon): comment the line above and use the named volume example below to avoid the MariaDB+virtiofs bug (see README/Troubleshooting)
      # - youtarr-db-data:/var/lib/mysql
      - ./config/mariadb.cnf:/etc/mysql/conf.d/charset.cnf:ro
    command: --port=${DB_PORT:-3321} --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-P", "${DB_PORT:-3321}", "-p${DB_PASSWORD:-123qweasd}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  youtarr:
    image: ${YOUTARR_IMAGE:-dialmaster/youtarr:latest}
    container_name: youtarr
    restart: unless-stopped
    # Optional: Run as specific UID:GID for security (defaults to root if not set per previous behavior)
    user: "${YOUTARR_UID:-0}:${YOUTARR_GID:-0}"
    depends_on:
      youtarr-db:
        condition: service_healthy
    environment:
      # DEPRECATED but retained for backwards compatibility with old images for now
      IN_DOCKER_CONTAINER: 1
      TZ: ${TZ:-UTC}
      DB_HOST: ${DB_HOST:-youtarr-db}
      DB_PORT: ${DB_PORT:-3321}
      DB_USER: ${DB_USER:-root}
      DB_PASSWORD: ${DB_PASSWORD:-123qweasd}
      DB_NAME: ${DB_NAME:-youtarr}
      # Optional: Disable authentication (for platforms with external auth like Elfhosted)
      AUTH_ENABLED: ${AUTH_ENABLED:-}
      # Optional: Seed initial admin credentials for headless deployments
      AUTH_PRESET_USERNAME: ${AUTH_PRESET_USERNAME:-}
      AUTH_PRESET_PASSWORD: ${AUTH_PRESET_PASSWORD:-}
      # Logging configuration
      LOG_LEVEL: ${LOG_LEVEL:-info}
      # This is just informational and lets the app know where the videos will be stored on the host
      YOUTUBE_OUTPUT_DIR: ${YOUTUBE_OUTPUT_DIR}
      # Optional: Custom data path for platforms like Elfhosted (defaults to /usr/src/app/data)
      # This is the internal path where videos download inside the container and is not needed for most users
      # DATA_PATH: /storage/rclone/storagebox/youtube

    ports:
      - "3087:3011"
    volumes:
      - ${YOUTUBE_OUTPUT_DIR}:/usr/src/app/data
      - ./server/images:/app/server/images
      - ./config:/app/config
      - ./jobs:/app/jobs
    healthcheck:
      test: ["CMD", "curl", "--fail", "--silent", "--show-error", "--output", "/dev/null", "http://localhost:3011/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  default:
    name: youtarr-network

# When switching the DB service to a named volume (Apple Silicon workaround),
# remember to define it here:
# volumes:
#   youtarr-db-data:
